<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>관리자 페이지 - 전자결재</title>
<style>
body, html {
	margin: 0;
	padding: 0;
	height: 100%;
	font-family: sans-serif;
	background-color: #f4f7f6;
}

.container {
	display: flex;
	height: 100vh;
}

.sidebar {
	width: 220px;
	background: #fff;
	padding: 20px;
	border-right: 1px solid #ddd;
}

.main-content {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
}

.top-nav {
	background: #343a40;
	color: white;
	padding: 15px 25px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	border-bottom: 3px solid #007bff;
}

.top-nav ul {
	margin: 0;
	padding: 0;
	list-style: none;
	display: flex;
}

.top-nav ul li {
	margin-right: 25px;
}

.top-nav a {
	color: white;
	text-decoration: none;
	cursor: pointer;
	font-size: 16px;
	transition: color 0.2s;
}

.top-nav a:hover {
	color: #007bff;
}

.content {
	padding: 30px;
	flex-grow: 1;
	background: #f4f7f6;
	overflow-y: auto;
}

.sidebar h2 {
	margin-top: 0;
	color: #333;
	border-bottom: 2px solid #eee;
	padding-bottom: 10px;
}

.sidebar ul {
	list-style: none;
	padding: 0;
}

.sidebar ul li a {
	display: block;
	padding: 12px 15px;
	color: #333;
	text-decoration: none;
	border-radius: 5px;
	transition: background-color 0.2s;
}

.sidebar ul li a:hover, .sidebar ul li a.active {
	background: #007bff;
	color: white;
}

.approval-section {
	background: #fff;
	padding: 25px;
	border-radius: 8px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.status-bar {
	margin-bottom: 20px;
	font-size: 18px;
	font-weight: bold;
}

.status-bar .status, .status {
	padding: 5px 12px;
	border-radius: 20px;
	color: white;
	font-size: 14px;
}

.status-반려, .status-반려 {
	background-color: #dc3545;
}

.status-결재대기, .status-결재대기 {
	background-color: #ffc107;
	color: #333 !important;
}

.status-승인완료, .status-승인 {
	background-color: #28a745;
}

.form-group {
	margin-bottom: 20px;
}

.form-group h3 {
	margin-top: 0;
	margin-bottom: 10px;
	font-size: 16px;
}

.form-group input[type="text"], .form-group input[type="number"],
	.form-group input[type="file"], .form-group textarea {
	width: 100%;
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	font-size: 14px;
	box-sizing: border-box;
}

.content-diff {
	display: flex;
	gap: 20px;
	margin-bottom: 20px;
}

.content-diff>div {
	flex: 1;
}

textarea {
	width: 100%;
	height: 150px;
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	font-size: 14px;
	box-sizing: border-box;
}

textarea[readonly] {
	background-color: #e9ecef;
}

.comment-section {
	margin-bottom: 20px;
}

.actions {
	border-top: 1px solid #eee;
	padding-top: 20px;
	text-align: right;
}

.actions button {
	padding: 10px 20px;
	border: none;
	border-radius: 5px;
	color: white;
	cursor: pointer;
	font-size: 15px;
	margin-left: 10px;
}

.actions button:disabled {
	background-color: #ccc;
	cursor: not-allowed;
}

#request-approval-btn, #user-approval-btn {
	background-color: #007bff;
}

#approve-btn {
	background-color: #28a745;
}

#reject-btn {
	background-color: #dc3545;
}

.notice-list-table {
	width: 100%;
	border-collapse: collapse;
}

.notice-list-table th, .notice-list-table td {
	border: 1px solid #ddd;
	padding: 12px;
	text-align: left;
}

.notice-list-table th {
	background-color: #f8f9fa;
}

.notice-list-table button {
	padding: 5px 10px;
	cursor: pointer;
	border: 1px solid #ccc;
	border-radius: 4px;
	background-color: #fff;
}
</style>
</head>
<body>

	<div class="main-content">
		<nav class="top-nav">
			<div class="logo">
				<a href="#">관리자 대시보드</a>
			</div>
			<ul id="top-menu">
				<li><a href="#" data-menu="approval">전자결재</a></li>
				<li><a href="#" data-menu="notice">공지사항관리</a></li>
				<li><a href="#" data-menu="product">상품관리</a></li>
				<li><a href="#" data-menu="report">전자보고서</a></li>
			</ul>
		</nav>
		<div class="container">
			<aside class="sidebar">
				<h2 id="sidebar-title">소분류 메뉴</h2>
				<ul id="sidebar-menu"></ul>
			</aside>
			<main class="content" id="main-content-area"></main>
		</div>
	</div>

	<script>

    // --- DOM Elements ---
    const topMenu = document.getElementById('top-menu');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const mainContentArea = document.getElementById('main-content-area');

    // --- Menu Definitions ---
    const submenus = {
        'approval': ['결재 문서 조회'],
        'notice': ['공지사항 목록', '공지사항 등록','결재 대기 목록','처리된 문서'],
        'product': ['상품 목록', '상품 등록'],
        'report': ['일일 보고서', '주간 보고서', '월간 보고서']
    };
    
    //공지사항 조회
    function showNoticeList() {
        console.log("공지사항 목록 조회 시작");
        
        fetch('/notice/getNoticeList')
        .then(response => {
            console.log("공지사항 목록 응답 상태:", response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("공지사항 목록 데이터:", data);
            
            if (!Array.isArray(data)) {
                console.error("받은 데이터가 배열이 아닙니다:", typeof data);
                throw new Error("서버에서 잘못된 형식의 데이터를 받았습니다.");
            }
            
            console.log("공지사항 개수:", data.length);

            let tableRows = data.map(notice => {
                return `
                    <tr>
                        <td>${notice.b_id || '-'}</td>
                        <td>
                            <a href="#" onclick="viewNoticeContent(${notice.b_id})" 
                               style="color: #007bff; text-decoration: none;">
                                ${notice.b_title || '제목 없음'}
                            </a>
                        </td>
                        <td>${notice.b_view || 0}</td>
                        <td>
                            <button onclick="viewNoticeContent(${notice.b_id})" 
                                    style="padding: 5px 10px; border: 1px solid #007bff; 
                                           background: #007bff; color: white; border-radius: 3px; cursor: pointer;">
                                보기
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const finalHTML = `
                <div class="approval-section">
                    <h2>공지사항 목록</h2>
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <small style="color: #666;">총 ${data.length}개의 공지사항</small>
                        <button onclick="showUserNoticeForm()" 
                                style="padding: 8px 15px; background: #28a745; color: white; 
                                       border: none; border-radius: 5px; cursor: pointer;">
                            새 공지사항 작성
                        </button>
                    </div>
                    <table class="notice-list-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">번호</th>
                                <th>제목</th>
                                <th style="width: 100px;">조회수</th>
                                <th style="width: 100px;">작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows.length > 0 ? tableRows : '<tr><td colspan="4">등록된 공지사항이 없습니다.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;

            console.log("공지사항 목록 HTML 생성 완료");
            mainContentArea.innerHTML = finalHTML;
        })
        .catch(err => {
            console.error("공지사항 목록 조회 에러:", err);
            alert('공지사항 목록 조회 중 오류가 발생했습니다: ' + err.message);
            
            mainContentArea.innerHTML = `
                <div class="approval-section">
                    <h2>공지사항 목록</h2>
                    <div style="color: red; padding: 20px; border: 1px solid red; border-radius: 5px;">
                        공지사항 목록 로딩 실패: ${err.message}
                    </div>
                </div>
            `;
        });
    }

    // 공지사항 상세 보기 함수
    function viewNoticeContent(b_id) {
        console.log("공지사항 상세 보기 - ID:", b_id);
        
        fetch('/notice/getNoticeList')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // 해당 ID의 공지사항 찾기
            const notice = data.find(item => item.b_id == b_id);
            
            if (!notice) {
                throw new Error('해당 공지사항을 찾을 수 없습니다.');
            }
            
            console.log('찾은 공지사항:', notice);
            
            mainContentArea.innerHTML = `
                <div class="approval-section">
                    <div style="margin-bottom: 20px;">
                        <button onclick="showNoticeList()" 
                                style="padding: 8px 15px; background: #6c757d; color: white; 
                                       border: none; border-radius: 5px; cursor: pointer;">
                            ← 목록으로 돌아가기
                        </button>
                    </div>
                    
                    <h2>공지사항 상세</h2>
                    
                    <div class="form-group">
                        <h3>제목</h3>
                        <div style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
                                    background-color: #f8f9fa; font-weight: bold;">
                            ${notice.b_title || '제목 없음'}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h3>내용</h3>
                        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; 
                                    background-color: #f8f9fa; min-height: 200px; white-space: pre-wrap;">
                            ${notice.b_content || '내용이 없습니다.'}
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                padding: 10px; background-color: #e9ecef; border-radius: 5px;">
                        <small style="color: #666;">
                            공지사항 번호: ${notice.b_id} | 조회수: ${notice.b_view || 0}
                        </small>
                    </div>
                    
                    <div class="actions" style="margin-top: 20px;">
                        <button onclick="showNoticeList()" 
                                style="padding: 10px 20px; background: #007bff; color: white; 
                                       border: none; border-radius: 5px; cursor: pointer;">
                            목록으로
                        </button>
                    </div>
                </div>
            `;
        })
        .catch(err => {
            console.error('공지사항 상세 조회 에러:', err);
            alert('공지사항 상세 조회 실패: ' + err.message);
        });
    }

    // --- View Render Functions ---

    function showUserNoticeForm() {
        mainContentArea.innerHTML = `
            <div class="approval-section">
                <h2>신규 공지사항 작성</h2>
                <div class="form-group">
                    <input type="text" name="title" placeholder="제목 입력">
                </div>
                <div class="form-group">
                    <textarea name="content" placeholder="내용 입력"></textarea>
                </div>
                <div class="form-group">
                    <input type="text" name="admin_comment" placeholder="작성자 의견">
                </div>
                <div class="actions">
                    <button id="user-approval-btn">등록요청</button>
                </div>
            </div>
        `;
        document.getElementById('user-approval-btn').addEventListener('click', userApprovalFunction);
    }

    function showPendingNoticeList() {
        console.log("결재 대기 목록 조회 시작");
        
        fetch('/notice/getPendingList')
        .then(response => {
            console.log("서버 응답 상태:", response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("서버에서 받은 전체 데이터:", data);
            
            if (!Array.isArray(data)) {
                console.error("받은 데이터가 배열이 아닙니다:", typeof data);
                throw new Error("서버에서 잘못된 형식의 데이터를 받았습니다.");
            }
            
            // 결재대기 상태인 항목만 필터링
            const pendingOnlyNotices = data.filter(item => {
                const status = item.status ? item.status.toString().trim() : '';
                const isPending = status === '결재대기';
                console.log(`ID ${item.p_id}: 상태="${status}" -> 결재대기 여부: ${isPending}`);
                return isPending;
            });
            
            console.log("필터링된 결재대기 항목:", pendingOnlyNotices);
            console.log("결재대기 항목 개수:", pendingOnlyNotices.length);

            let tableRows = pendingOnlyNotices.map(notice => {
                return `
                    <tr>
                        <td>${notice.p_id || '-'}</td>
                        <td>${notice.b_title || '-'}</td>
                        <td>${notice.b_created_at || '-'}</td>
                        <td>
                            <span class="status status-결재대기">결재대기</span>
                        </td>
                        <td>
                            <button onclick="viewNoticeDetail(${notice.p_id})">보기</button>
                        </td>
                    </tr>
                `;
            }).join('');

            const finalHTML = `
                <div class="approval-section">
                    <h2>결재 대기 목록</h2>
                    <div style="margin-bottom: 10px;">
                        <small>총 ${pendingOnlyNotices.length}개의 결재 대기 항목</small>
                    </div>
                    <table class="notice-list-table">
                        <thead>
                            <tr>
                                <th>결재 ID</th>
                                <th>제목</th>
                                <th>작성일</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows.length > 0 ? tableRows : '<tr><td colspan="5">결재 대기중인 항목이 없습니다.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;

            console.log("최종 HTML 생성 완료");
            mainContentArea.innerHTML = finalHTML;
        })
        .catch(err => {
            console.error("에러 발생:", err);
            alert('데이터 조회 중 오류가 발생했습니다: ' + err.message);
            
            mainContentArea.innerHTML = `
                <div class="approval-section">
                    <h2>결재 대기 목록</h2>
                    <div style="color: red; padding: 20px; border: 1px solid red; border-radius: 5px;">
                        데이터 로딩 실패: ${err.message}
                    </div>
                </div>
            `;
        });
    }

    
    function viewNoticeDetail(p_id) {
        fetch('/notice/getPendingById?p_id=' + p_id)
            .then(response => response.json())
            .then(notice => {
                mainContentArea.innerHTML = `
                    <div class="approval-section">
                        <h2>공지사항 결재</h2>
                        <div class="form-group">
                            <h3>제목</h3>
                            <input type="text" value="${notice.b_title}" readonly>
                        </div>
                        <div class="form-group">
                            <h3>내용</h3>
                            <textarea readonly>${notice.b_content}</textarea>
                        </div>
                        <div class="form-group">
                            <h3>작성자 의견</h3>
                            <input type="text" value="${notice.admin_comment}" readonly>
                        </div>
                        <hr>
                        <div class="comment-section">
                            <h3>반려 사유</h3>
                            <textarea id="rejection-reason" placeholder="반려 시 사유를 입력합니다."></textarea>
                        </div>
                        <div class="actions">
                        	<button id="approve-btn" data-pid="${p_id}">승인</button>
                        	<button id="reject-btn" data-pid="${p_id}">반려</button>
                    	</div>
                        
                    </div>
                `;

                // 버튼 클릭 이벤트 등록 (렌더링 후에 실행)
                document.getElementById('approve-btn').addEventListener('click', (e) => {
                    handleDecision(e.target.dataset.pid, '승인');
                });

                document.getElementById('reject-btn').addEventListener('click', (e) => {
                    const reason = document.getElementById('rejection-reason').value;
                    if (!reason.trim()) {
                        alert('반려 사유를 입력해야 합니다.');
                        return;
                    }
                    handleDecision(e.target.dataset.pid, '반려', reason);
                });
            })
            .catch(err => {
                console.error(err);
                alert('데이터 조회 실패');
            });
    }
    
 // 처리된 문서 목록 (승인, 반려만 표시)
    function viewCompleteList() {
        console.log("처리된 문서 목록 조회 시작");
        
        fetch('/notice/getPendingList')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("처리된 문서 조회 - 원본 데이터:", data);
            
            // 승인 또는 반려된 문서만 필터링 (결재대기 제외)
            const completedNotices = data.filter(item => {
                const status = item.status ? item.status.toString().trim() : '';
                const isCompleted = status === '승인' || status === '반려';
                console.log(`ID ${item.p_id}: 상태="${status}" -> 처리완료 여부: ${isCompleted}`);
                return isCompleted;
            });
            
            console.log("필터링된 처리 완료 문서:", completedNotices);
            
            let tableRows = completedNotices.map(notice => {
                const status = notice.status ? notice.status.toString().trim() : '상태없음';
                return `
                    <tr>
                        <td>${notice.p_id || '-'}</td>
                        <td>${notice.b_title || '-'}</td>
                        <td>${notice.b_created_at || '-'}</td>
                        <td>
                            <span class="status status-${status}">${status}</span>
                        </td>
                        <td>${notice.rejected_comment || '-'}</td>
                        <td>
                            <button onclick="viewNoticeDetail(${notice.p_id})">상세 보기</button>
                        </td>
                    </tr>
                `;
            }).join('');

            mainContentArea.innerHTML = `
                <div class="approval-section">
                    <h2>처리된 문서 목록</h2>
                    <div style="margin-bottom: 10px;">
                        <small>총 ${completedNotices.length}개의 처리된 문서 (승인/반려)</small>
                    </div>
                    <table class="notice-list-table">
                        <thead>
                            <tr>
                                <th>결재 ID</th>
                                <th>제목</th>
                                <th>작성일</th>
                                <th>최종 상태</th>
                                <th>반려 사유</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows.length ? tableRows : '<tr><td colspan="6">처리된 문서가 없습니다.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(err => {
            console.error("처리된 문서 조회 에러:", err);
            alert('처리된 문서 조회 중 오류가 발생했습니다: ' + err.message);
        });
    }

    // 전체 목록 보기 함수 (필요시 사용)
    function showAllNoticeList() {
        console.log("전체 목록 조회 시작");
        
        fetch('/notice/getPendingList')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("전체 데이터:", data);
            
            // 상태별 개수 계산
            const statusCounts = data.reduce((counts, item) => {
                const status = item.status ? item.status.toString().trim() : '상태없음';
                counts[status] = (counts[status] || 0) + 1;
                return counts;
            }, {});
            
            console.log("상태별 개수:", statusCounts);
            
            let tableRows = data.map(notice => {
                const status = notice.status ? notice.status.toString().trim() : '상태없음';
                return `
                    <tr>
                        <td>${notice.p_id || '-'}</td>
                        <td>${notice.b_title || '-'}</td>
                        <td>${notice.b_created_at || '-'}</td>
                        <td>
                            <span class="status status-${status}">${status}</span>
                        </td>
                        <td>${notice.rejected_comment || '-'}</td>
                        <td>
                            <button onclick="viewNoticeDetail(${notice.p_id})">보기</button>
                        </td>
                    </tr>
                `;
            }).join('');

            const statusSummary = Object.entries(statusCounts)
                .map(([status, count]) => `${status}: ${count}개`)
                .join(', ');

            mainContentArea.innerHTML = `
                <div class="approval-section">
                    <h2>전체 문서 목록</h2>
                    <div style="margin-bottom: 10px;">
                        <small>총 ${data.length}개 항목 (${statusSummary})</small>
                    </div>
                    <table class="notice-list-table">
                        <thead>
                            <tr>
                                <th>결재 ID</th>
                                <th>제목</th>
                                <th>작성일</th>
                                <th>상태</th>
                                <th>반려 사유</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows.length ? tableRows : '<tr><td colspan="6">데이터가 없습니다.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(err => {
            console.error("전체 목록 조회 에러:", err);
            alert('데이터 조회 중 오류가 발생했습니다: ' + err.message);
        });
    }


    function showPlaceholderContent(menuKey) {
        const menuName = topMenu.querySelector(`[data-menu="${menuKey}"]`).value;
        mainContentArea.innerHTML = `<h1>${menuName}</h1><p>이 페이지의 콘텐츠는 아직 구현되지 않았습니다.</p>`;
    }
    
    function updateSidebar(menuKey) {
        const menuName = topMenu.querySelector(`[data-menu=${menuKey}]`).textContent;
        document.getElementById('sidebar-title').textContent = menuName;
        sidebarMenu.innerHTML = '';
        (submenus[menuKey] || []).forEach(item => {
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.action = item;
            a.textContent = item;
            sidebarMenu.appendChild(document.createElement('li')).appendChild(a);
        });
    }

    function userApprovalFunction() {
        const title = document.querySelector('input[name=title]').value;
        const content = document.querySelector('textarea[name=content]').value;
        const admin_comment = document.querySelector('input[name=admin_comment]').value;
        
        // 입력값 검증
        if (!title.trim()) {
            alert('제목을 입력해주세요.');
            return;
        }
        if (!content.trim()) {
            alert('내용을 입력해주세요.');
            return;
        }
        
        const createdAt = new Date().toISOString().split('T')[0];
        const noticeData = {
            b_title: title,
            b_content: content,
            b_created_at: createdAt,
            status: '결재대기',
            admin_comment: admin_comment,
        };

        console.log("서버로 전송할 데이터:", noticeData);
        
        fetch('/notice/writeApproval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(noticeData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            console.log('서버 응답:', data);
            if (data === '데이터저장 성공') {
                alert('결재 상신 완료!');
                showPendingNoticeList();
            } else {
                alert('데이터 저장 실패: ' + data);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error: ' + err.message);
        });
    }

    
 // 결재 처리 함수 (승인/반려)
    async function handleDecision(p_id, status, rejected_comment = '') {
        console.log(`서버로 결재 결정 전송: ID=${p_id}, 결정=${status}, 사유=${rejected_comment}`);
        
        const noticeData = {
            p_id: parseInt(p_id),
            status: status,
            rejected_comment: rejected_comment
        };
        
        try {
            const response = await fetch('/notice/uploadApprove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(noticeData)
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const result = await response.text();
            console.log('서버 응답:', result);
            alert(result);
            
            // 결재 대기 목록 새로고침
            showPendingNoticeList();
            
        } catch (err) {
            console.error('Error:', err);
            alert('Error: ' + err.message);
        }
    }

    // 메인메뉴 버튼을 누르면 활성화 되도록 만들어주는 함수
    topMenu.addEventListener('click', e => {
        if (e.target.tagName !== 'A') return;
        e.preventDefault();
        const menuKey = e.target.dataset.menu;
        updateSidebar(menuKey);
        if (menuKey === 'notice') showPendingNoticeList();
        else showPlaceholderContent(menuKey);
    });
    
	// 사이드바 버튼을 누르면 활성화 되도록 만들어주는 함수
    sidebarMenu.addEventListener('click', e => {
        if (e.target.tagName !== 'A') return;
        e.preventDefault();
        const action = e.target.dataset.action;
        if (action === '결재 대기 목록') showPendingNoticeList();
        else if (action === '공지사항 등록') showUserNoticeForm();
        else if (action === '처리된 문서')viewCompleteList();
        else if (action === '공지사항 목록')showNoticeList();
        else showPlaceholderContent(action);
    });

    document.addEventListener('DOMContentLoaded', () => {
        topMenu.querySelector('[data-menu="notice"]').click();
    });
 // 결재 상세 보기 함수
    function viewNoticeDetail(p_id) {
        fetch('/notice/getPendingById?p_id=' + p_id)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(notice => {
                console.log('받은 데이터:', notice);
                
                // 이미 처리된 문서인지 확인
                const isProcessed = notice.status === '승인' || notice.status === '반려';
                
                mainContentArea.innerHTML = `
                    <div class="approval-section">
                        <h2>공지사항 결재</h2>
                        <div class="status-bar">
                            <span class="status status-${notice.status}">${notice.status}</span>
                        </div>
                        <div class="form-group">
                            <h3>제목</h3>
                            <input type="text" value="${notice.b_title || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <h3>내용</h3>
                            <textarea readonly>${notice.b_content || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <h3>작성자 의견</h3>
                            <input type="text" value="${notice.admin_comment || ''}" readonly>
                        </div>
                        ${notice.rejected_comment ? `
                            <div class="form-group">
                                <h3>반려 사유</h3>
                                <input type="text" value="${notice.rejected_comment}" readonly>
                            </div>
                        ` : ''}
                        <hr>
                        ${!isProcessed ? `
                            <div class="comment-section">
                                <h3>반려 사유</h3>
                                <textarea id="rejection-reason" placeholder="반려 시 사유를 입력합니다."></textarea>
                            </div>
                            <div class="actions">
                                <button id="approve-btn" data-pid="${p_id}">승인</button>
                                <button id="reject-btn" data-pid="${p_id}">반려</button>
                            </div>
                        ` : `
                            <div class="actions">
                                <p>이미 처리된 문서입니다.</p>
                            </div>
                        `}
                    </div>
                `;

                // 처리되지 않은 문서에만 버튼 이벤트 등록
                if (!isProcessed) {
                    document.getElementById('approve-btn').addEventListener('click', (e) => {
                        if (confirm('승인하시겠습니까?')) {
                            handleDecision(e.target.dataset.pid, '승인');
                        }
                    });

                    document.getElementById('reject-btn').addEventListener('click', (e) => {
                        const reason = document.getElementById('rejection-reason').value;
                        if (!reason.trim()) {
                            alert('반려 사유를 입력해야 합니다.');
                            return;
                        }
                        if (confirm('반려하시겠습니까?')) {
                            handleDecision(e.target.dataset.pid, '반려', reason);
                        }
                    });
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('데이터 조회 실패: ' + err.message);
            });
    }
</script>

</body>
</html>

