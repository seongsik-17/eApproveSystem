<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>관리자 페이지 - 전자결재</title>
<style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background-color: #f4f7f6; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #fff; padding: 20px; border-right: 1px solid #ddd; }
    .main-content { flex-grow: 1; display: flex; flex-direction: column; }
    .top-nav { background: #343a40; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #007bff; }
    .top-nav ul { margin: 0; padding: 0; list-style: none; display: flex; }
    .top-nav ul li { margin-right: 25px; }
    .top-nav a { color: white; text-decoration: none; cursor: pointer; font-size: 16px; transition: color 0.2s; }
    .top-nav a:hover { color: #007bff; }
    .content { padding: 30px; flex-grow: 1; background: #f4f7f6; overflow-y: auto; }
    .sidebar h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li a { display: block; padding: 12px 15px; color: #333; text-decoration: none; border-radius: 5px; transition: background-color 0.2s; }
    .sidebar ul li a:hover, .sidebar ul li a.active { background: #007bff; color: white; }
    
    .approval-section { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .status-bar { margin-bottom: 20px; font-size: 18px; font-weight: bold; }
    .status-bar .status, .status { padding: 5px 12px; border-radius: 20px; color: white; font-size: 14px; }
    .status-DRAFT, .status-반려 { background-color: #dc3545; }
    .status-PENDING, .status-결재대기 { background-color: #ffc107; color: #333 !important; }
    .status-APPROVED, .status-승인완료 { background-color: #28a745; }

    .form-group { margin-bottom: 20px; }
    .form-group h3 { margin-top: 0; margin-bottom: 10px; font-size: 16px; }
    .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="file"], .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .content-diff { display: flex; gap: 20px; margin-bottom: 20px; }
    .content-diff > div { flex: 1; }
    textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
    textarea[readonly] { background-color: #e9ecef; }
    .comment-section { margin-bottom: 20px; }
    .actions { border-top: 1px solid #eee; padding-top: 20px; text-align: right; }
    .actions button { padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 15px; margin-left: 10px; }
    .actions button:disabled { background-color: #ccc; cursor: not-allowed; }
    #request-approval-btn, #user-approval-btn { background-color: #007bff; }
    #approve-btn { background-color: #28a745; }
    #reject-btn { background-color: #dc3545; }

    .notice-list-table { width: 100%; border-collapse: collapse; }
    .notice-list-table th, .notice-list-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .notice-list-table th { background-color: #f8f9fa; }
    .notice-list-table button { padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; }
</style>
</head>
<body>

    <div class="main-content">
        <nav class="top-nav">
            <div class="logo"><a href="#">관리자 대시보드</a></div>
            <ul id="top-menu">
                <li><a href="#" data-menu="approval">전자결재</a></li>
                <li><a href="#" data-menu="notice">공지사항관리</a></li>
                <li><a href="#" data-menu="product">상품관리</a></li>
                <li><a href="#" data-menu="report">전자보고서</a></li>
            </ul>
        </nav>
        <div class="container">
            <aside class="sidebar">
                <h2 id="sidebar-title">소분류 메뉴</h2>
                <ul id="sidebar-menu"></ul>
            </aside>
            <main class="content" id="main-content-area"></main>
        </div>
    </div>
	<input type="hidden" value="${userInfo.roll}">
<script>
	
	
   

    // --- DOM Elements ---
    const topMenu = document.getElementById('top-menu');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const mainContentArea = document.getElementById('main-content-area');

    // --- Menu Definitions ---
    const submenus = {
        'approval': ['결재 문서 조회'],
        'notice': ['결재 대기 목록', '공지사항 등록'],
        'product': ['상품 목록', '상품 등록'],
        'report': ['일일 보고서', '주간 보고서', '월간 보고서']
    };

    // --- View Render Functions ---

    function showUserNoticeForm() {
        mainContentArea.innerHTML = `
            <div class="approval-section">
                <h2>신규 공지사항 작성</h2>
                <div class="form-group">
                    <input type="text" name="title" placeholder="제목 입력">
                </div>
                <div class="form-group">
                    <textarea name="content" placeholder="내용 입력"></textarea>
                </div>
                <div class="form-group">
                    <input type="text" name="admin_comment" placeholder="작성자 의견">
                </div>
                <div class="actions">
                    <button id="user-approval-btn">등록요청</button>
                </div>
            </div>
        `;
        document.getElementById('user-approval-btn').addEventListener('click', userApprovalFunction);
    }

    function showPendingNoticeList() {
    	fetch('/notice/getPendingList')
        .then(response => response.json())
        .then(data => {
            const pendingNotices = data;

            let tableRows = pendingNotices.map(notice => `
                <tr>
                    <td>${notice.p_id}</td>
                    <td>${notice.b_title}</td>
                    <td>${notice.b_created_at}</td>
                    <td><span class="status status-${notice.status}">${notice.status}</span></td>
                    <td><button onclick="viewNoticeDetail(${notice.p_id})">보기</button></td>
                </tr>
            `).join('');

            mainContentArea.innerHTML = `
                <div class="approval-section">
                    <h2>결재 대기 목록</h2>
                    <table class="notice-list-table">
                        <thead>
                            <tr>
                                <th>결재 ID</th>
                                <th>제목</th>
                                <th>작성일</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows || '<tr><td colspan="5">결재 대기중인 항목이 없습니다.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(err => {
            alert('Error: ' + err);
        });

    }

    function viewNoticeDetail(p_id) {
        fetch('/notice/getPendingById?p_id=' + p_id)
            .then(response => response.json())
            .then(notice => {
                mainContentArea.innerHTML = `
                    <div class="approval-section">
                        <h2>공지사항 결재</h2>
                        <div class="form-group">
                            <h3>제목</h3>
                            <input type="text" value="${notice.b_title}" readonly>
                        </div>
                        <div class="form-group">
                            <h3>내용</h3>
                            <textarea readonly>${notice.b_content}</textarea>
                        </div>
                        <div class="form-group">
                            <h3>작성자 의견</h3>
                            <input type="text" value="${notice.admin_comment}" readonly>
                        </div>
                        <hr>
                        <div class="comment-section">
                            <h3>반려 사유</h3>
                            <textarea id="rejection-reason" placeholder="반려 시 사유를 입력합니다."></textarea>
                        </div>
                        <div class="actions" th:if="${userInfo.role == 'MASTER'}">
                        	<button id="approve-btn" data-pid="${p_id}">승인</button>
                        	<button id="reject-btn" data-pid="${p_id}">반려</button>
                    	</div>
                        
                    </div>
                `;

                // 버튼 클릭 이벤트 등록 (렌더링 후에 실행)
                document.getElementById('approve-btn').addEventListener('click', (e) => {
                    handleDecision(e.target.dataset.pid, 'APPROVE');
                });

                document.getElementById('reject-btn').addEventListener('click', (e) => {
                    const reason = document.getElementById('rejection-reason').value;
                    if (!reason.trim()) {
                        alert('반려 사유를 입력해야 합니다.');
                        return;
                    }
                    handleDecision(e.target.dataset.pid, 'REJECT', reason);
                });
            })
            .catch(err => {
                console.error(err);
                alert('데이터 조회 실패');
            });
    }


    function showPlaceholderContent(menuKey) {
        const menuName = topMenu.querySelector(`[data-menu=${menuKey}]`).textContent;
        mainContentArea.innerHTML = `<h1>${menuName}</h1><p>이 페이지의 콘텐츠는 아직 구현되지 않았습니다.</p>`;
    }
    
    function updateSidebar(menuKey) {
        const menuName = topMenu.querySelector(`[data-menu=${menuKey}]`).textContent;
        document.getElementById('sidebar-title').textContent = menuName;
        sidebarMenu.innerHTML = '';
        (submenus[menuKey] || []).forEach(item => {
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.action = item;
            a.textContent = item;
            sidebarMenu.appendChild(document.createElement('li')).appendChild(a);
        });
    }

    // --- Event Handlers & API Calls ---

    function userApprovalFunction() {
        const title = document.querySelector('input[name=title]').value;
        const content = document.querySelector('textarea[name=content]').value;
        const createdAt = new Date().toISOString().split('T')[0];
        const admin_comment = document.querySelector('input[name=admin_comment]').value;
        const noticeData = {
            b_title: title, b_content: content, b_created_at: createdAt,
            status: '결재대기', admin_comment: admin_comment,
        };

        console.log("서버로 전송할 데이터:", noticeData);
        fetch('/notice/writeApproval',{
        	method: 'POST',
        	headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(noticeData)
        })
        .then(response =>{
        	if(!response == '데이터저장 성공'){
        		alert('데이터 저장 실패');
        	}else{
        		alert('결재 상신 완료!');
        		showPendingNoticeList();
        	}
        })
        .catch(err =>{
        	alert('Error: '+ err)
        });
        // Mockup 로직
        const newId = Math.max(...mockServerData.map(d => d.p_id)) + 1;
        mockServerData.push({ p_id: newId, b_id: null, rejected_comment: null, ...noticeData });
        
        alert("승인 요청이 완료되었습니다.");
        showPendingNoticeList();
    }

    async function handleDecision(p_id, decision, reason = '') {
        console.log(`서버로 결재 결정 전송: ID=${p_id}, 결정=${decision}, 사유=${reason}`);
        // fetch('/api/notice/decide', { method: 'POST', body: JSON.stringify({ p_id, decision, reason }) });
        
        // Mockup 로직
        const notice = mockServerData.find(item => item.p_id == p_id);
        if(notice) {
            notice.status = (decision === 'APPROVE') ? '승인완료' : '반려';
            notice.rejected_comment = reason;
        }
        alert(`결재가 '${decision}' 처리되었습니다.`);
        showPendingNoticeList();
    }

    // --- Initial Event Listeners ---

    topMenu.addEventListener('click', e => {
        if (e.target.tagName !== 'A') return;
        e.preventDefault();
        const menuKey = e.target.dataset.menu;
        updateSidebar(menuKey);
        if (menuKey === 'notice') showPendingNoticeList();
        else showPlaceholderContent(menuKey);
    });

    sidebarMenu.addEventListener('click', e => {
        if (e.target.tagName !== 'A') return;
        e.preventDefault();
        const action = e.target.dataset.action;
        if (action === '결재 대기 목록') showPendingNoticeList();
        else if (action === '공지사항 등록') showUserNoticeForm();
        else showPlaceholderContent(action);
    });

    document.addEventListener('DOMContentLoaded', () => {
        topMenu.querySelector('[data-menu="notice"]').click();
    });
</script>

</body>
</html>

